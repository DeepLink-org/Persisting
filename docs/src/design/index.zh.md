# 设计文档

本节包含描述 Persisting 架构和实现细节的设计文档。

## 概述

Persisting 被设计为一个模块化的持久化存储系统，与 Pulsing 的分布式队列基础设施集成。关键设计原则包括：

- **可插拔架构** - 存储后端可以在不更改应用代码的情况下切换
- **Pulsing 集成** - 与 Pulsing Actor 框架无缝集成
- **生产就绪** - 企业级功能如 WAL、监控和 Schema 演进

## 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          应用层                                  │
│                                                                 │
│    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐    │
│    │ QueueWriter │     │ QueueReader │     │   Queue     │    │
│    └──────┬──────┘     └──────┬──────┘     └──────┬──────┘    │
│           │                   │                   │            │
│           └───────────────────┴───────────────────┘            │
│                               │                                 │
└───────────────────────────────┼─────────────────────────────────┘
                                │
┌───────────────────────────────┼─────────────────────────────────┐
│                         Pulsing 层                              │
│                               │                                 │
│              ┌────────────────┴────────────────┐                │
│              │        StorageManager          │                │
│              │      (每节点一个 Actor)         │                │
│              └────────────────┬────────────────┘                │
│                               │                                 │
│         ┌─────────────────────┼─────────────────────┐          │
│         │                     │                     │          │
│    ┌────┴─────┐         ┌────┴─────┐         ┌────┴─────┐     │
│    │ Bucket 0 │         │ Bucket 1 │         │ Bucket N │     │
│    └────┬─────┘         └────┬─────┘         └────┬─────┘     │
│         │                    │                    │            │
└─────────┼────────────────────┼────────────────────┼────────────┘
          │                    │                    │
┌─────────┼────────────────────┼────────────────────┼────────────┐
│         │               后端层                    │            │
│         │                    │                    │            │
│    ┌────┴─────┐         ┌────┴─────┐         ┌────┴─────┐     │
│    │ Backend  │         │ Backend  │         │ Backend  │     │
│    │(Memory/  │         │(Lance/   │         │(Custom)  │     │
│    │ Lance)   │         │Persisting│         │          │     │
│    └────┬─────┘         └────┬─────┘         └────┬─────┘     │
│         │                    │                    │            │
└─────────┼────────────────────┼────────────────────┼────────────┘
          │                    │                    │
┌─────────┼────────────────────┼────────────────────┼────────────┐
│         │               存储层                    │            │
│         ▼                    ▼                    ▼            │
│    ┌─────────┐          ┌─────────┐          ┌─────────┐      │
│    │  内存   │          │  Lance  │          │  自定义  │      │
│    │         │          │  文件   │          │  存储   │      │
│    └─────────┘          └─────────┘          └─────────┘      │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 文档

- [架构设计](architecture.md) - 整体系统架构
- [Write-Ahead Log](wal.md) - WAL 设计与实现

## 设计原则

### 1. 关注点分离

每层有明确的职责：

- **应用层**：高级队列 API
- **Pulsing 层**：分布式 Actor 管理
- **后端层**：存储抽象
- **存储层**：实际数据持久化

### 2. 基于协议的抽象

`StorageBackend` 协议定义了清晰的契约：

```python
class StorageBackend(Protocol):
    async def put(self, record: dict[str, Any]) -> None: ...
    async def get(self, offset: int, limit: int) -> list[dict]: ...
    async def flush(self) -> None: ...
    # ...
```

### 3. 组合优于继承

后端被组合到 `BucketStorage` Actor 中，而不是从基类继承。

### 4. 安全的默认值

- 测试用的内存后端（无外部依赖）
- 合理的默认配置
- 优雅降级

## 后续工作

- [ ] 多区域复制
- [ ] 分层存储（热/冷）
- [ ] 查询优化
- [ ] 备份和恢复工具

